# سير عمل الخطوات (Step Workflow)

## نظرة عامة

نظام سير عمل الخطوات يسمح بمراجعة واعتماد الخطوات (الإجراءات) قبل تنفيذها. يمر كل إجراء عبر مراحل محددة من المراجعة والموافقة.

---

## المفاهيم الأساسية

### العلاقة بين النشاط والخطوات

```
┌─────────────────────────────────────────────────────────────────┐
│                         المشروع (Project)                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   ┌─────────────────────────────────────────────────────────┐  │
│   │                    النشاط (Activity)                     │  │
│   ├─────────────────────────────────────────────────────────┤  │
│   │                                                         │  │
│   │   ┌─────────┐   ┌─────────┐   ┌─────────┐   ┌────────┐ │  │
│   │   │ خطوة 1  │   │ خطوة 2  │   │ خطوة 3  │   │ خطوة n │ │  │
│   │   │ (إجراء) │   │ (إجراء) │   │ (إجراء) │   │ (إجراء)│ │  │
│   │   └─────────┘   └─────────┘   └─────────┘   └────────┘ │  │
│   │        ↓             ↓             ↓             ↓      │  │
│   │   ┌─────────────────────────────────────────────────┐  │  │
│   │   │           سير العمل (لكل خطوة على حدة)          │  │  │
│   │   └─────────────────────────────────────────────────┘  │  │
│   │                                                         │  │
│   └─────────────────────────────────────────────────────────┘  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

> **ملاحظة مهمة**: يتم إرسال الخطوات واحدة تلو الأخرى إلى سير العمل، وليس دفعة واحدة.

---

## مراحل سير العمل

### الرسم البياني الكامل

```
┌─────────────────────────────────────────────────────────────────────┐
│                    سير عمل الخطوات                                    │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   ┌──────────┐     ┌─────────────────┐     ┌─────────────────┐     │
│   │  مسودة   │ ──► │ فريق التخطيط   │ ──► │ مشرف التنفيذ   │     │
│   │  draft   │     │ (مراجعة الإجراء) │     │(توزيع المستهدفات)│     │
│   └──────────┘     └────────┬────────┘     └────────┬────────┘     │
│        │                    │                       │               │
│        │              ┌─────┴─────┐                 │               │
│        │              │           │                 │               │
│        │              ▼           ▼                 ▼               │
│        │        ┌──────────┐ ┌──────────┐    ┌──────────┐          │
│        │        │  معاد    │ │  مرفوض  │    │  مكتمل   │          │
│        │        │ returned │ │ rejected │    │completed │          │
│        │        └────┬─────┘ └──────────┘    └──────────┘          │
│        │             │                                              │
│        │             │ إعادة إرسال بعد التعديل                      │
│        │             ▼                                              │
│        └──────► العودة لفريق التخطيط ◄───────────────────           │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### وصف المراحل

| المرحلة | الحالة | الفريق المسؤول | الإجراءات المتاحة |
|---------|--------|----------------|-------------------|
| **مسودة** | `draft` | صاحب الخطوة | إرسال للمراجعة |
| **مراجعة التخطيط** | `in_progress` | فريق التخطيط | موافقة، إرجاع، رفض |
| **توزيع المستهدفات** | `in_progress` | مشرف التنفيذ | موافقة، إرجاع، رفض |
| **معاد** | `returned` | صاحب الخطوة | إعادة إرسال بعد التعديل |
| **مكتمل** | `completed` | - | لا يوجد (حالة نهائية) |
| **مرفوض** | `rejected` | - | لا يوجد (حالة نهائية) |

---

## كيفية عمل النظام

### 1. إرسال الخطوة للمراجعة

```php
// المستخدم يضغط "إرسال للمراجعة"
// النظام يبحث تلقائياً عن سير العمل المناسب

$workflow = Workflow::where('entity_type', Step::class)
    ->where('is_active', true)
    ->first();

// ثم يربط الخطوة بسير العمل ويرسلها للمرحلة الأولى
$service->assignWorkflow($step, $workflow->id, $user, autoSubmit: true);
```

### 2. مراجعة فريق التخطيط

عند وصول الخطوة لفريق التخطيط:

- **الموافقة**: تنتقل الخطوة للمرحلة التالية (مشرف التنفيذ)
- **الإرجاع**: ترجع الخطوة للمستخدم مع كتابة الملاحظات
- **الرفض**: يتم رفض الخطوة نهائياً

### 3. إعادة الإرسال بعد الإرجاع

عندما يتم إرجاع الخطوة:
1. تظهر ملاحظات فريق التخطيط للمستخدم
2. المستخدم يعدل الخطوة بناءً على الملاحظات
3. المستخدم يضغط "إعادة الإرسال"
4. الخطوة ترجع لفريق التخطيط للمراجعة مرة أخرى

---

## البنية التقنية

### الملفات المعنية

| الملف | الوظيفة |
|-------|---------|
| `app/Models/Step.php` | نموذج الخطوة (يطبق HasWorkflow) |
| `app/Http/Controllers/StepController.php` | التحكم في إجراءات الخطوة |
| `app/Services/WorkflowService.php` | محرك سير العمل |
| `resources/views/step/show.blade.php` | صفحة عرض الخطوة |
| `resources/views/step/partials/workflow-actions.blade.php` | واجهة إجراءات سير العمل |
| `resources/views/step/partials/step-status.blade.php` | عرض حالة الخطوة |

### المسارات (Routes)

```php
// إرسال الخطوة لسير العمل
POST /step/submit
Route: step.submit

// الموافقة على الخطوة
POST /step/{step}/approve
Route: step.approve

// إرجاع الخطوة مع التعليق
POST /step/{step}/return
Route: step.return

// رفض الخطوة
POST /step/{step}/reject
Route: step.reject
```

### قاعدة البيانات

```
┌─────────────────────┐     ┌─────────────────────┐
│       steps         │     │  workflow_instances │
├─────────────────────┤     ├─────────────────────┤
│ id                  │◄───►│ workflowable_id     │
│ name                │     │ workflowable_type   │
│ activity_id         │     │ workflow_id         │
│ project_id          │     │ current_stage_id    │
│ status              │     │ status              │
│ ...                 │     │ stage_due_at        │
└─────────────────────┘     └─────────────────────┘
                                      │
                                      ▼
                            ┌─────────────────────┐
                            │workflow_transitions │
                            ├─────────────────────┤
                            │ workflowable_id     │
                            │ workflowable_type   │
                            │ actor_id            │
                            │ from_stage_id       │
                            │ to_stage_id         │
                            │ action              │
                            │ comments            │
                            └─────────────────────┘
```

---

## إعداد سير العمل

### الخطوة 1: إنشاء تعريف سير العمل

1. اذهب إلى: **سير العمل** ← **تعريفات سير العمل** ← **إضافة تعريف جديد**
2. اختر **نوع الكيان**: خطوة (Step)
3. أدخل اسم سير العمل: "سير عمل مراجعة الخطوات"

### الخطوة 2: إضافة المراحل

| الترتيب | اسم المرحلة | الفريق | يمكن الموافقة | يمكن الإرجاع | المدة (أيام) |
|---------|-------------|--------|--------------|--------------|--------------|
| 10 | مراجعة التخطيط | فريق التخطيط | ✓ | ✓ | 3 |
| 20 | توزيع المستهدفات | مشرفو التنفيذ | ✓ | ✓ | 5 |

### الخطوة 3: إضافة الأعضاء للفرق

1. اذهب إلى: **سير العمل** ← **إدارة الفرق**
2. أضف المستخدمين المناسبين لكل فريق

---

## الصلاحيات المطلوبة

| الصلاحية | الوصف |
|----------|-------|
| `workflow.pending` | عرض العناصر المعلقة |
| `workflow.approve` | الموافقة على العناصر |
| `workflow.return` | إرجاع العناصر |
| `workflow.reject` | رفض العناصر |

---

## واجهة المستخدم

### حالات العرض

#### 1. مسودة (Draft)
- يظهر زر "إرسال للمراجعة"
- لون الخلفية: أصفر

#### 2. قيد المراجعة (In Progress)
- يظهر شريط تقدم المراحل
- تظهر أزرار الإجراءات للفريق المخول
- لون الخلفية: أزرق

#### 3. معاد للتعديل (Returned)
- تظهر ملاحظات الإرجاع
- يظهر زر "إعادة الإرسال"
- لون الخلفية: أصفر

#### 4. مكتمل (Completed)
- رسالة نجاح
- لون الخلفية: أخضر

#### 5. مرفوض (Rejected)
- رسالة الرفض مع السبب
- لون الخلفية: أحمر

---

## أمثلة عملية

### مثال 1: إرسال خطوة جديدة

```php
// في Controller
public function stepSubmit(Request $request, WorkflowService $service)
{
    $step = Step::findOrFail($request->step_id);
    
    // النظام يجد سير العمل تلقائياً
    $workflow = Workflow::where('entity_type', Step::class)
        ->where('is_active', true)
        ->first();
    
    // يربط ويرسل
    $service->assignWorkflow($step, $workflow->id, auth()->user(), autoSubmit: true);
    
    return back()->with('success', 'تم الإرسال');
}
```

### مثال 2: الموافقة على خطوة

```php
public function stepApprove(Request $request, Step $step, WorkflowService $service)
{
    $service->approveStep($step, auth()->user(), $request->comments);
    
    return back()->with('success', 'تمت الموافقة');
}
```

### مثال 3: إرجاع خطوة مع ملاحظات

```php
public function stepReturn(Request $request, Step $step, WorkflowService $service)
{
    $service->returnStep(
        $step,
        auth()->user(),
        null, // المرحلة السابقة تلقائياً
        $request->comments // "يرجى تعديل تاريخ البداية"
    );
    
    return back()->with('success', 'تم الإرجاع');
}
```

---

## استكشاف الأخطاء

### المشكلة: "لا يوجد سير عمل مُعرّف"

**السبب**: لم يتم إنشاء تعريف سير عمل للخطوات

**الحل**: 
1. اذهب إلى تعريفات سير العمل
2. أنشئ تعريفاً جديداً بنوع الكيان "خطوة"

### المشكلة: المستخدم لا يرى أزرار الإجراءات

**السبب**: المستخدم ليس في الفريق المسؤول عن المرحلة الحالية

**الحل**:
1. تحقق من أن المستخدم مضاف للفريق الصحيح
2. تحقق من صلاحيات المستخدم

### المشكلة: الخطوة لا تظهر في "العناصر المعلقة"

**السبب**: الخطوة قد تكون في مرحلة أخرى أو مكتملة

**الحل**:
1. تحقق من حالة الخطوة
2. تحقق من المرحلة الحالية والفريق المسؤول

---

## التحديثات والتعديلات

### التاريخ: يناير 2026

- ✅ إضافة نظام سير العمل للخطوات
- ✅ إضافة واجهة إجراءات سير العمل
- ✅ دعم إعادة الإرسال بعد الإرجاع
- ✅ عرض سجل الإجراءات

---

## الوثائق ذات الصلة

- [بنية سير العمل](workflow_architecture.md)
- [دليل المطورين](developer-guide.md)
- [الأدوار والصلاحيات](roles-permissions.md)

---

**آخر تحديث**: يناير 2026  
**الإصدار**: 1.0.0
